<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Mclick</title>
  </head>
  <body onload="on_load()">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
          integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
          crossorigin="anonymous"></script>
    <script>
      let socket = io();
      let settings = {};

      function send_updates()
      {
        settings["tempo_output"    ] = document.getElementById("tempo_output").value;
        settings["measure_volume"  ] = document.getElementById("measure_volume").value;
        settings["measure_length"  ] = document.getElementById("measure_length").value;
        settings["measure_options" ] = document.getElementById("measure_options").value;
        settings["beat_volume"     ] = document.getElementById("beat_volume").value;
        settings["eighth_volume"   ] = document.getElementById("eighth_volume").value;
        settings["swing_value"     ] = document.getElementById("swing_value").value;
        settings["sixteenth_volume"] = document.getElementById("sixteenth_volume").value;

        let measure_length_img = document.getElementById('measure_length_img');
        measure_length_img.src = "../static/" + settings["measure_length"] + ".svg";
        measure_length_img.alt = str(settings["measure_length"]) + ' beats';
        socket.emit("push_params", settings);
      }

      function update_tempo_drag()
      {
        let tempo_val = document.getElementById("tempo_slider").value;
        document.getElementById("tempo_output").value = document.getElementById("tempo_slider").value;
      }

      function meter_clicked(button_id)
      {
        let meters = document.getElementById("measure_options").value.split(",").map(Number);
        let current_meter = parseInt(document.getElementById("measure_length").value);
        let meter_idx = meters.indexOf(current_meter);

        if (button_id == "meter_up" && (meter_idx < meters.length - 1))
        {
          meter_idx += 1;
        } else if (button_id == "meter_down" && meter_idx > 0)
        {
            meter_idx -= 1;
        }
        document.getElementById("measure_length").value = meters[meter_idx];
        send_updates()
      }


      function get_meter_icon()
      {
        return
      }
    </script>

    <div>
        <div style="display: table-row;">
          <div style="display: table-cell;">
            <h1>MIDI Metronome</h1>
          </div>
          <div style="display: table-cell;">
            <img alt="Mclick Logo" src="../static/mclick.svg">
          </div>
        </div>

        <form id="param_form" method="POST" enctype="multipart/form-data">
          <div style="display: table-row;">
              <div style="display: table-cell;">
                <img alt="quarter note" src="../static/quarter.svg" height="80">
              </div>
              <div style="display: table-cell;">
                <div class="slidecontainer">
                    <!-- onSlideCompleted â†’ -->
                    <input type="range"
                       min="40" max="240"
                       value="{{ parameters.tempo }}"
                       class="slider"
                       oninput="update_tempo_drag()"
                       onchange="send_updates()"
                       name="tempo_slider"
                       id="tempo_slider">
               </div>
             </div>
             <div style="display: table-cell;">
               <output name="tempo_output" id="tempo_output">{{ parameters.tempo }}</output>
             </div>
          </div>

          <!-- Measure Slider -->
          <div style="display: table-row;">
            <div style="display: table-cell;">
              <img alt="measure" src="../static/whole.svg" height="70">
            </div>
            <div style="display: table-cell;">
              <div class="slidecontainer">
                <input type="range" min="0" max="127"
                value="{{ parameters.measure_volume }}"
                class="slider"  name="measure_volume" id="measure_volume" onchange="send_updates()">
              </div>
            </div>
            <div style="display: table-cell">
              <img alt="{{ parameters.measure_length }} beats" name="measure_length_img" id="measure_length_img" src="../static/{{ parameters.measure_length }}.svg" height="70">
              <input type="hidden" name="measure_length" id="measure_length" value="{{ parameters.measure_length }}" >
              <input type="hidden" name="measure_options" id="measure_options" value="{{ parameters.measure_options }}" >
            </div>
            <div style="display: table-cell">
              <div style="display: table-row;">
                  <button type="button" onclick="meter_clicked(this.id)" id="meter_up" title="up">/\</button>
              </div>
              <div style="display: table-row;">
                  <button type="button"  onclick="meter_clicked(this.id)" id="meter_down" title="down">\/</button>
              </div>
            </div>
          </div> <!-- row -->

          <!-- Beat Slider -->
          <div style="display: table-row;">
            <div style="display: table-cell;">
              <img alt="beat" src="../static/quarter.svg" height="80">
            </div>
            <div style="display: table-cell;">
              <div class="slidecontainer">
                <input type="range" min="0" max="127"
                    value={{ parameters.beat_volume }}
                    class="slider"  name="beat_volume" id="beat_volume" onchange="send_updates()">
              </div>
            </div>
          </div> <!-- row -->

          <!-- Eight note  Slider -->
          <div style="display: table-row;">
            <div style="display: table-cell;">
              <img alt="eighth note" src="../static/eighth.svg" height="80">
            </div>
            <div style="display: table-cell;">
              <div class="slidecontainer">
              <input type="range" min="0" max="127"
                    value = {{ parameters.eighth_volume }}
                    class="slider"  name="eighth_volume" id="eighth_volume" onchange="send_updates()">
              </div>
            </div>
        </div>

        <!-- Swing Slider -->
        <div style="display: table-row;">
          <div style="display: table-cell;">
            <img alt="straight time" src="../static/straight.svg" height="80">
          </div>
          <div style="display: table-cell;">
            <div class="slidecontainer">
              <input type="range" min="0" max="100"
                    value={{ parameters.swing_value }}
                    class="slider" name="swing_value" id="swing_value" onchange="send_updates()">
              </div>
          </div>
          <div style="display: table-cell;">
              <img alt="swing" src="../static/swing.svg" height="100">
          </div>
        </div>

          <!-- Sixteenth Note Slider -->
          <div style="display: table-row;">
            <div style="display: table-cell;">
              <img alt="sixteenth note" src="../static/sixteenth.svg" height="80">
            </div>
            <div style="display: table-cell;">
              <div class="slidecontainer">
                  <input type="range" min="0" max="127"
                        value={{ parameters.sixteenth_volume }}
                        class="slider"  name="sixteenth_volume" id="sixteenth_volume" onchange="send_updates()">
              </div>
            </div>
          </div>
        </form>
    </div>
  </body>
</html>
